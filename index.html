<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ravid Translator</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Round-Dots/fonts/webfonts/Vazirmatn-RD-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Round-Dots/fonts/webfonts/Vazirmatn-RD-Medium.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Round-Dots/fonts/webfonts/Vazirmatn-RD-Bold.woff2') format('woff2');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Round-Dots/fonts/webfonts/Vazirmatn-RD-SemiBold.woff2') format('woff2');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --font-primary: 'Vazirmatn', Arial, sans-serif;
            --primary-hue: 210;
            --secondary-hue: 35;
            --accent-hue: 280;
            --primary-color-light: hsl(var(--primary-hue), 79%, 60%);
            --primary-color-dark: hsl(var(--primary-hue), 79%, 40%);
            --primary-gradient: linear-gradient(140deg, var(--primary-color-light) 0%, var(--primary-color-dark) 100%);
            --secondary-color-light: hsl(var(--secondary-hue), 95%, 65%);
            --secondary-color-dark: hsl(var(--secondary-hue), 90%, 50%);
            --secondary-gradient: linear-gradient(140deg, var(--secondary-color-light) 0%, var(--secondary-color-dark) 100%);
            --accent-color: hsl(var(--accent-hue), 60%, 65%);
            --text-color-light: #212529;
            --text-color-muted-light: #5f6368;
            --bg-color-light: #fcfdff;
            --surface-color-light: #ffffff;
            --border-color-light: hsl(var(--primary-hue), 30%, 88%);
            --text-color-dark: #e9ecef;
            --text-color-muted-dark: #adb5bd;
            --bg-color-dark: #1a1d24;
            --surface-color-dark: #232731;
            --border-color-dark: hsl(var(--primary-hue), 15%, 30%);
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: var(--secondary-color-light);
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
            --spacing-unit: 8px;
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.03);
            --shadow-sm: 0 2px 5px rgba(0,0,0,0.05), 0 1px 1px rgba(0,0,0,0.03);
            --shadow-md: 0 5px 15px rgba(0,0,0,0.07), 0 2px 5px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.1), 0 5px 10px rgba(0,0,0,0.06);
            --shadow-xl: 0 20px 50px rgba(0,0,0,0.15), 0 8px 15px rgba(0,0,0,0.08);
            --transition-fast: 0.15s ease-out;
            --transition-medium: 0.3s ease-out;
            --transition-slow: 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-bounce: 0.4s cubic-bezier(0.68, -0.55, 0.26, 1.55);
            --text-color: var(--text-color-light);
            --text-color-muted: var(--text-color-muted-light);
            --bg-color: var(--bg-color-light);
            --surface-color: var(--surface-color-light);
            --border-color: var(--border-color-light);
            --primary-color: var(--primary-color-light);
            --primary-color-hover: var(--primary-color-dark);
            --secondary-color: var(--secondary-color-light);
            --surface-color-rgb: 255,255,255;
            --success-hue: 134; --error-hue: 354;
        }

        body.dark-mode {
            --text-color: var(--text-color-dark);
            --text-color-muted: var(--text-color-muted-dark);
            --bg-color: var(--bg-color-dark);
            --surface-color: var(--surface-color-dark);
            --border-color: var(--border-color-dark);
            --primary-color: var(--primary-color-light);
            --primary-color-hover: hsl(var(--primary-hue), 79%, 70%);
            --secondary-color: var(--secondary-color-light);
            --surface-color-rgb: 35,39,49;
        }
       
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
       
        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            font-family: var(--font-primary);
            direction: rtl;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color var(--transition-medium), color var(--transition-medium);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::-webkit-scrollbar {
            width: 10px;
        }
        body::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        body::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 20px;
            border: 2px solid var(--bg-color);
        }
        body.dark-mode::-webkit-scrollbar-thumb {
            background-color: var(--primary-color-light);
             border: 2px solid var(--bg-color-dark);
        }
        
        /* --- START: HEADER AND SETTINGS STYLES --- */
        .header {
            padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2.5);
            color: var(--white);
            position: relative;
            background: var(--primary-gradient);
            border-bottom: 3px solid var(--primary-color-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow: visible; 
        }

        .header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                radial-gradient(hsl(var(--primary-hue), 79%, 90%, 0.1) 1px, transparent 1px),
                radial-gradient(hsl(var(--primary-hue), 79%, 90%, 0.1) 1px, transparent 1px);
            background-size: 30px 30px, 30px 30px;
            background-position: 0 0, 15px 15px;
            animation: bgPatternAnim 30s linear infinite;
            opacity: 0.5;
            z-index: 1;
        }

        .header h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
            letter-spacing: -0.5px;
            z-index: 2;
        }
       
        .header-actions {
            position: relative;
            z-index: 1005;
        }

        .header-icon-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            transition: all var(--transition-medium);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: scale(1.1) rotate(25deg);
        }

        .settings-popup {
            position: absolute;
            top: calc(100% + 12px);
            right: 0; /* Changed from left to right */
            width: 320px;
            background-color: hsla(var(--surface-color-rgb, 255, 255, 255), 0.75);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            backdrop-filter: blur(12px) saturate(180%);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid hsla(var(--border-color-light), 0.5);
            z-index: 1002;
            padding: calc(var(--spacing-unit) * 2);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transform-origin: top right; /* Added for correct animation */
            transition: opacity var(--transition-medium) ease-out, transform var(--transition-medium) ease-out, visibility 0s var(--transition-medium);
            color: var(--text-color);
        }

        body.dark-mode .settings-popup {
            background-color: hsla(var(--surface-color-rgb, 35, 39, 49), 0.75);
            border: 1px solid hsla(var(--border-color-dark), 0.6);
        }

        .settings-popup.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            transition: opacity var(--transition-bounce) 0.1s, transform var(--transition-bounce) 0.1s, visibility 0s;
        }

        .settings-section {
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
        }
        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section h4 {
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-color);
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            padding-bottom: calc(var(--spacing-unit) * 1.5);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-unit) * 1.2);
        }
        body.dark-mode .settings-section h4 {
            color: var(--primary-color-light);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(var(--spacing-unit) * 1.5) var(--spacing-unit);
            gap: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius-sm);
            transition: background-color var(--transition-fast);
        }
        .setting-item:hover {
            background-color: hsla(var(--primary-hue), 20%, 50%, 0.08);
        }
        body.dark-mode .setting-item:hover {
            background-color: hsla(var(--primary-hue), 15%, 50%, 0.15);
        }

        .setting-item label {
            font-weight: 500;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .toggle-switch {
            -webkit-appearance: none;
            appearance: none;
            width: 48px;
            height: 26px;
            background-color: hsla(var(--primary-hue), 15%, 50%, 0.5);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background-color var(--transition-medium);
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            top: 3px;
            right: 25px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: right var(--transition-medium);
        }
        .toggle-switch:checked {
            background-color: var(--primary-color);
        }
        body.dark-mode .toggle-switch:checked {
             background-color: var(--secondary-color);
        }
        .toggle-switch:checked::before {
            right: 3px;
        }

        .settings-popup select,
        .settings-popup input[type="range"] {
            flex-grow: 1;
        }
        .settings-popup select {
            min-width: 0;
            width: auto;
        }
         .settings-popup input[type="range"] {
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        /* --- END: HEADER AND SETTINGS STYLES --- */

        .container {
            flex: 1;
            padding: calc(var(--spacing-unit) * 4) calc(var(--spacing-unit) * 2);
            max-width: 1280px;
            margin: 0 auto;
            width: 100%;
        }
       
        .translator-box {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 3);
            background: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: calc(var(--spacing-unit) * 3.5);
            box-shadow: var(--shadow-xl);
            transition: transform var(--transition-medium), box-shadow var(--transition-medium);
            border: 1px solid var(--border-color);
            position: relative;
        }
        .translator-box::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: inherit;
            background: linear-gradient(45deg, var(--primary-color-light), var(--accent-color), var(--secondary-color-light));
            z-index: -1;
            opacity: 0;
            filter: blur(15px);
            transition: opacity var(--transition-slow);
        }
        .translator-box:hover::after {
            opacity: 0.15;
        }
        body.dark-mode .translator-box:hover::after {
            opacity: 0.25;
        }
       
        @media (min-width: 1024px) {
            .translator-box {
                flex-direction: row;
                gap: calc(var(--spacing-unit) * 4);
            }
        }
       
        .language-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-unit);
            position: relative;
        }
        #lang-detect-indicator {
            color: var(--primary-color);
            vertical-align: middle;
        }
        body.dark-mode #lang-detect-indicator {
            color: var(--primary-color-light);
        }

        .language-label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
            position: absolute;
            top: calc(var(--spacing-unit) * -2.5);
            right: var(--spacing-unit);
            background-color: var(--surface-color);
            padding: 0 calc(var(--spacing-unit) * 0.5);
            border-radius: var(--border-radius-sm);
            transition: color var(--transition-medium), background-color var(--transition-medium);
        }
       
        .language-selector {
            display: flex;
            gap: var(--spacing-unit);
            align-items: center;
            margin: 0 auto;
        }
       
        .swap-btn {
            background: var(--secondary-gradient);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform var(--transition-bounce), box-shadow var(--transition-medium);
            box-shadow: 0 3px 8px hsla(var(--secondary-hue), 90%, 50%, 0.4);
            z-index: 10;
            flex-shrink: 0;
        }
       
        .swap-btn:hover {
            transform: scale(1.1) rotate(25deg);
            box-shadow: 0 6px 15px hsla(var(--secondary-hue), 90%, 50%, 0.5);
        }
        .swap-btn:active {
            transform: scale(0.95) rotate(10deg);
        }
       
        .swap-btn svg {
            width: 28px; height: 28px;
        }
        .swap-btn svg path {
            stroke: #ffffff;
            stroke-width: 2.5;
        }
        body.dark-mode .swap-btn svg path {
             stroke: var(--text-color-dark);
        }
       
        .text-area-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            min-width: 0;
        }
       
        .text-area {
            width: 100%;
            height: 300px;
            padding: calc(var(--spacing-unit) * 2);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            resize: none;
            font-family: var(--font-primary);
            font-size: 1.05rem;
            line-height: 1.75;
            background-color: var(--surface-color);
            color: var(--text-color);
            transition: border-color var(--transition-medium), box-shadow var(--transition-medium), background-color var(--transition-medium);
        }
        .text-area::placeholder {
            color: var(--text-color-muted);
            opacity: 0.8;
        }
       
        .text-area:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px hsla(var(--primary-hue), 79%, 60%, 0.2), var(--shadow-sm);
            background-color: var(--surface-color);
        }
        body.dark-mode .text-area:focus {
            box-shadow: 0 0 0 4px hsla(var(--primary-hue), 79%, 70%, 0.25), var(--shadow-sm);
        }

        .text-area::-webkit-scrollbar {
            width: 8px;
        }
        .text-area::-webkit-scrollbar-track {
            background: transparent;
            border-radius: var(--border-radius-md);
        }
        .text-area::-webkit-scrollbar-thumb {
            background-color: hsla(var(--primary-hue), 79%, 60%, 0.5);
            border-radius: 10px;
        }
        .text-area:hover::-webkit-scrollbar-thumb {
            background-color: hsla(var(--primary-hue), 79%, 60%, 0.8);
        }
        body.dark-mode .text-area::-webkit-scrollbar-thumb {
            background-color: hsla(var(--primary-hue), 79%, 70%, 0.4);
        }
         body.dark-mode .text-area:hover::-webkit-scrollbar-thumb {
            background-color: hsla(var(--primary-hue), 79%, 70%, 0.7);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-unit);
            align-items: center;
            gap: var(--spacing-unit);
        }
       
        .btn {
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-family: var(--font-primary);
            font-weight: 600;
            padding: calc(var(--spacing-unit) * 1.2) calc(var(--spacing-unit) * 2.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-unit);
            transition: all var(--transition-fast);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        .btn i {
            transition: transform var(--transition-fast);
        }
        .btn:hover i {
            transform: scale(1.1);
        }

        .translate-btn {
            background: var(--primary-gradient);
            color: #ffffff;
            padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 4);
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 12px hsla(var(--primary-hue), 79%, 50%, 0.35);
        }
       
        .translate-btn:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 7px 20px hsla(var(--primary-hue), 79%, 50%, 0.45);
        }
       
        .translate-btn:active {
            transform: translateY(0px) scale(0.98);
            box-shadow: 0 2px 8px hsla(var(--primary-hue), 79%, 50%, 0.3);
        }

        .translate-btn.loading {
            pointer-events: none;
            color: transparent !important;
        }
        .translate-btn.loading .btn-text, .translate-btn.loading .btn-icon {
            visibility: hidden;
        }
        .translate-btn .spinner {
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        .translate-btn.loading .spinner {
            display: block;
        }
       
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .clear-btn {
            background-color: transparent;
            color: var(--text-color-muted);
            border: 1.5px solid var(--border-color);
        }
       
        .clear-btn:hover {
            background-color: hsla(var(--primary-hue), 20%, 95%, 1);
            border-color: hsla(var(--primary-hue), 20%, 80%, 1);
            color: var(--text-color);
        }
        body.dark-mode .clear-btn {
            color: var(--text-color-muted-dark);
            border-color: var(--border-color-dark);
        }
        body.dark-mode .clear-btn:hover {
            background-color: hsla(var(--primary-hue), 15%, 25%, 1);
            border-color: hsla(var(--primary-hue), 15%, 40%, 1);
            color: var(--text-color-dark);
        }

        .copy-btn {
            background-color: hsl(var(--primary-hue), 60%, 96%);
            color: var(--primary-color);
            border: 1px solid hsl(var(--primary-hue), 60%, 90%);
        }
        .copy-btn:hover {
            background-color: hsl(var(--primary-hue), 60%, 92%);
            border-color: hsl(var(--primary-hue), 60%, 85%);
            transform: scale(1.02);
        }
         body.dark-mode .copy-btn {
            background-color: hsla(var(--primary-hue), 20%, 28%, 1);
            color: var(--primary-color-light);
            border-color: hsla(var(--primary-hue), 20%, 35%, 1);
        }
        body.dark-mode .copy-btn:hover {
            background-color: hsla(var(--primary-hue), 20%, 32%, 1);
        }
       
        select {
            padding: calc(var(--spacing-unit) * 1.3) calc(var(--spacing-unit) * 2);
            padding-left: calc(var(--spacing-unit) * 5);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-family: var(--font-primary);
            font-weight: 500;
            background-color: var(--surface-color);
            color: var(--text-color);
            min-width: 180px;
            cursor: pointer;
            transition: all var(--transition-medium);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left calc(var(--spacing-unit) * 1.5) center;
        }
        body.dark-mode select {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='%23e9ecef' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
       
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px hsla(var(--primary-hue), 79%, 60%, 0.15);
        }
        select:hover {
            border-color: hsla(var(--primary-hue), 79%, 70%, 0.7);
        }
       
        .loading {
            display: none;
            text-align: center;
            padding: calc(var(--spacing-unit) * 4) 0;
            font-size: 1.1rem;
            color: var(--text-color-muted);
        }
       
        .loader {
            border: 6px solid hsla(var(--primary-hue), 79%, 60%, 0.2);
            border-radius: 50%;
            border-top: 6px solid var(--primary-color);
            width: 60px;
            height: 60px;
            animation: spin 0.7s linear infinite;
            margin: 0 auto calc(var(--spacing-unit) * 2);
        }
       
        .char-count {
            font-size: 0.9rem;
            color: var(--text-color-muted);
            transition: color var(--transition-medium), transform var(--transition-fast);
            font-weight: 500;
        }
       
        .char-count.warning { color: var(--warning-color); transform: scale(1.05); }
        .char-count.danger { color: var(--error-color); font-weight: 600; transform: scale(1.1); }
       
        .footer {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 4) calc(var(--spacing-unit) * 2);
            text-align: center;
            color: var(--text-color-muted);
            margin-top: calc(var(--spacing-unit) * 6);
            border-top: 1px solid var(--border-color);
            transition: background-color var(--transition-medium), border-color var(--transition-medium);
        }
       
        .footer p {
            margin: var(--spacing-unit) 0;
            font-size: 0.95rem;
        }
        .footer .fa-heart { color: var(--error-color); animation: heartbeat 1.5s infinite ease-in-out; }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
       
        .footer .social-links {
            margin-top: calc(var(--spacing-unit) * 2);
            display: flex;
            justify-content: center;
            gap: calc(var(--spacing-unit) * 2.5);
        }
       
        .footer .social-links a {
            color: var(--text-color-muted);
            font-size: 1.6rem;
            transition: color var(--transition-medium), transform var(--transition-medium);
        }
       
        .footer .social-links a:hover {
            color: var(--primary-color);
            transform: translateY(-4px) scale(1.15);
        }
       
        .notification {
            position: fixed;
            top: calc(var(--spacing-unit) * 3);
            left: 50%;
            transform: translateX(-50%) translateY(-150px) scale(0.9);
            color: #ffffff;
            padding: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 3.5);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-unit) * 1.5);
            font-weight: 600;
            font-size: 1.05rem;
            z-index: 1000;
            opacity: 0;
            transition: transform var(--transition-bounce), opacity var(--transition-medium);
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .notification.success { background: hsla(var(--success-hue, 134), 61%, 41%, 0.7); }
        .notification.error { background: hsla(var(--error-hue, 354), 70%, 54%, 0.7); }
        body.dark-mode .notification {
            background: rgba(40, 43, 51, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        body.dark-mode .notification.success { background: hsla(var(--success-hue, 134), 61%, 35%, 0.7); }
        body.dark-mode .notification.error { background: hsla(var(--error-hue, 354), 70%, 48%, 0.7); }

        .notification.show {
            transform: translateX(-50%) translateY(0) scale(1);
            opacity: 1;
        }
        .notification i { font-size: 1.3em; }

        .language-feature {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: calc(var(--spacing-unit) * 3.5);
            margin-top: calc(var(--spacing-unit) * 7);
        }
       
        .feature-item {
            background: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: calc(var(--spacing-unit) * 3);
            text-align: center;
            box-shadow: var(--shadow-lg);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow var(--transition-medium);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
       
        .feature-item:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: var(--shadow-xl);
        }
        .feature-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg);
            transition: left 0.7s ease-in-out;
        }
        .feature-item:hover::before {
            left: 150%;
        }
        body.dark-mode .feature-item::before {
             background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0) 100%);
        }
       
        .feature-icon {
            background: linear-gradient(135deg, hsla(var(--primary-hue), 79%, 60%, 0.15) 0%, hsla(var(--primary-hue), 79%, 40%, 0.1) 100%);
            width: 75px;
            height: 75px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto calc(var(--spacing-unit) * 2.5);
            color: var(--primary-color);
            font-size: 2.2rem;
            transition: all var(--transition-slow);
        }
        .feature-item:hover .feature-icon {
            background: var(--primary-gradient);
            color: #ffffff;
            transform: rotateY(360deg) scale(1.1);
            box-shadow: 0 5px 15px hsla(var(--primary-hue), 79%, 50%, 0.3);
        }
       
        .feature-title {
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: var(--spacing-unit);
            color: var(--text-color);
        }
        body.dark-mode .feature-title { color: var(--primary-color-light); }
       
        .feature-desc {
            color: var(--text-color-muted);
            font-size: 0.95rem;
            line-height: 1.7;
        }
       
        .target-container { position: relative; }
       
        .action-buttons {
            position: absolute;
            top: calc(var(--spacing-unit) * 1.5);
            left: calc(var(--spacing-unit) * 1.5);
            display: flex;
            gap: calc(var(--spacing-unit) * 0.75);
            background: hsla(var(--surface-color-rgb, 255,255,255), 0.8);
            padding: calc(var(--spacing-unit) * 0.5);
            border-radius: var(--border-radius-sm);
            backdrop-filter: blur(5px);
            box-shadow: var(--shadow-xs);
            opacity: 0.7;
            transition: opacity var(--transition-medium);
        }
        .text-area-container:hover .action-buttons {
            opacity: 1;
        }
       
        .action-btn {
            background: transparent;
            border: none;
            border-radius: var(--border-radius-sm);
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-color-muted);
            transition: all var(--transition-fast);
        }
       
        .action-btn:hover {
            background-color: var(--primary-color);
            color: #ffffff;
            transform: scale(1.1);
        }
         body.dark-mode .action-btn:hover {
            background-color: var(--primary-color-light);
            color: var(--bg-color-dark);
        }
       
        .history-panel {
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            padding: calc(var(--spacing-unit) * 3);
            margin-top: calc(var(--spacing-unit) * 5);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }
       
        .history-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: calc(var(--spacing-unit) * 2.5);
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-unit) * 1.5);
        }
        .history-title i {
            color: var(--primary-color);
            font-size: 1.2em;
        }
       
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            border-radius: var(--border-radius-md);
        }
        .history-list::-webkit-scrollbar { width: 6px; }
        .history-list::-webkit-scrollbar-track { background: transparent; }
        .history-list::-webkit-scrollbar-thumb { background-color: hsla(var(--primary-hue), 79%, 60%, 0.3); border-radius: 6px; }
        .history-list:hover::-webkit-scrollbar-thumb { background-color: hsla(var(--primary-hue), 79%, 60%, 0.6); }
        body.dark-mode .history-list::-webkit-scrollbar-thumb { background-color: hsla(var(--primary-hue), 79%, 70%, 0.25); }
        body.dark-mode .history-list:hover::-webkit-scrollbar-thumb { background-color: hsla(var(--primary-hue), 79%, 70%, 0.5); }
       
        .history-item {
            padding: calc(var(--spacing-unit) * 1.8) calc(var(--spacing-unit) * 2);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color var(--transition-medium), transform var(--transition-fast);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-unit);
        }
        .history-item:last-child { border-bottom: none; margin-bottom: 0; }
       
        .history-item:hover {
            background-color: hsla(var(--primary-hue), 60%, 95%, 0.7);
            transform: translateX(-5px);
            box-shadow: var(--shadow-sm);
        }
        body.dark-mode .history-item:hover {
            background-color: hsla(var(--primary-hue), 15%, 22%, 0.7);
        }
       
        .history-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            font-size: 0.95rem;
            font-weight: 500;
            margin-right: var(--spacing-unit);
        }
       
        .history-langs {
            color: var(--primary-color);
            font-size: 0.9rem;
            font-weight: 600;
            margin-right: var(--spacing-unit) * 1.5;
            white-space: nowrap;
            display: inline-flex; align-items: center; gap: calc(var(--spacing-unit) * 0.5);
        }
        .history-langs .fa-long-arrow-alt-left { opacity: 0.6; }
        body.dark-mode .history-langs { color: var(--secondary-color); }
       
        .history-item .date-time {
            color: var(--text-color-muted);
            font-size: 0.8rem;
            white-space: nowrap;
            text-align: left;
            min-width: 110px;
        }
       
        .voice-btn {
            background-color: hsla(var(--primary-hue), 20%, 95%, 1);
            border: 1px solid hsla(var(--primary-hue), 20%, 85%, 1);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary-color);
            transition: all var(--transition-medium);
            box-shadow: var(--shadow-sm);
        }
       
        .voice-btn:hover {
            background-color: var(--primary-color);
            color: #ffffff;
            transform: scale(1.12);
            box-shadow: 0 3px 10px hsla(var(--primary-hue), 79%, 60%, 0.3);
        }
       
        .voice-btn.recording {
            background-color: var(--error-color);
            color: #ffffff;
            animation: pulseError 1.5s infinite;
            box-shadow: 0 0 15px hsla(var(--error-hue), 70%, 54%, 0.5);
        }
        @keyframes pulseError {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
         body.dark-mode .voice-btn {
            background-color: hsla(var(--primary-hue), 15%, 28%, 1);
            border-color: hsla(var(--primary-hue), 15%, 35%, 1);
            color: var(--primary-color-light);
         }
         body.dark-mode .voice-btn:hover {
            background-color: var(--primary-color-light);
            color: var(--bg-color-dark);
            box-shadow: 0 3px 10px hsla(var(--primary-hue), 79%, 70%, 0.3);
         }
         body.dark-mode .voice-btn.recording {
            background-color: var(--error-color);
            color: #ffffff;
            box-shadow: 0 0 15px hsla(var(--error-hue), 70%, 54%, 0.5);
         }

        .tone-selector-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: calc(var(--spacing-unit) * 2);
            margin-top: calc(var(--spacing-unit) * 4);
            margin-bottom: calc(var(--spacing-unit) * 1);
            padding: calc(var(--spacing-unit) * 2);
            background-color: hsla(var(--primary-hue), 30%, 97%, 1);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-medium), border-color var(--transition-medium);
        }

        body.dark-mode .tone-selector-container {
            background-color: hsla(var(--primary-hue), 15%, 21%, 1);
            border-color: hsla(var(--primary-hue), 15%, 28%, 1);
        }

        .tone-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .tone-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: calc(var(--spacing-unit) * 1.25);
            justify-content: center;
        }

        .tone-btn {
            background-color: var(--surface-color);
            color: var(--text-color-muted);
            border: 1.5px solid var(--border-color);
            padding: calc(var(--spacing-unit) * 0.8) calc(var(--spacing-unit) * 2);
            font-weight: 500;
            border-radius: var(--border-radius-md);
            transition: all var(--transition-medium);
            box-shadow: var(--shadow-xs);
        }

        .tone-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .tone-btn.active {
            background: var(--primary-gradient);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 4px 10px hsla(var(--primary-hue), 79%, 50%, 0.3);
            transform: translateY(-2px);
        }
        .tone-btn.active:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px hsla(var(--primary-hue), 79%, 50%, 0.4);
        }

        body.dark-mode .tone-btn {
            background-color: var(--surface-color-dark);
            color: var(--text-color-muted-dark);
            border-color: var(--border-color-dark);
        }

        body.dark-mode .tone-btn:hover {
            border-color: var(--primary-color-light);
            color: var(--primary-color-light);
            box-shadow: var(--shadow-sm);
        }

        body.dark-mode .tone-btn.active {
            border-color: transparent;
            box-shadow: 0 4px 10px hsla(var(--primary-hue), 79%, 60%, 0.35);
        }
         body.dark-mode .tone-btn.active:hover {
             box-shadow: 0 6px 15px hsla(var(--primary-hue), 79%, 60%, 0.45);
        }
       
        @media (max-width: 768px) {
            html { font-size: 15px; }
            .header {
                padding: calc(var(--spacing-unit) * 1.5) var(--spacing-unit);
                flex-direction: column;
                gap: var(--spacing-unit);
            }
             .header-actions {
                align-self: flex-end;
             }
            .container { padding: calc(var(--spacing-unit) * 2.5) var(--spacing-unit); }
           
            .translator-box {
                padding: calc(var(--spacing-unit) * 2.5);
                flex-direction: column;
            }
            .language-selector {
                align-self: center;
                margin: var(--spacing-unit) 0 calc(var(--spacing-unit) * 2);
            }
            .swap-btn {
                transform: rotate(90deg);
            }
            .swap-btn:hover {
                transform: rotate(115deg) scale(1.1);
            }
            .text-area { height: 250px; }
           
            .language-feature {
                grid-template-columns: 1fr;
                gap: calc(var(--spacing-unit) * 2.5);
                margin-top: calc(var(--spacing-unit) * 5);
            }
             .feature-item:hover {
                transform: translateY(-6px) scale(1.01);
            }
            .translate-btn {
                padding: calc(var(--spacing-unit) * 1.3) calc(var(--spacing-unit) * 3);
                font-size: 1rem;
            }
            
             .history-item { flex-wrap: wrap; gap: var(--spacing-unit) * 0.5; }
             .history-text { width: 100%; order: 1; }
             .history-langs { order: 2; margin-right: 0; }
             .history-item .date-time { width: 100%; order: 3; text-align: right; font-size: 0.75rem; }

            .tone-selector-container {
                flex-direction: column;
                gap: calc(var(--spacing-unit) * 1.5);
                padding: calc(var(--spacing-unit) * 1.5);
                margin-top: calc(var(--spacing-unit) * 3);
            }
            .tone-buttons {
                gap: var(--spacing-unit);
            }
            .tone-btn {
                padding: calc(var(--spacing-unit) * 0.8) calc(var(--spacing-unit) * 1.5);
                font-size: 0.9rem;
            }
        }
         @media (max-width: 480px) {
            html { font-size: 14px; }
            .header h1 { letter-spacing: -0.2px; }
            .controls {
                flex-direction: column;
                gap: var(--spacing-unit);
                align-items: stretch;
            }
            .controls .btn { width: 100%; }
            .action-buttons { padding: calc(var(--spacing-unit) * 0.3); }
            .action-btn { width: 34px; height: 34px; }
            select { min-width: 150px; }
            .voice-btn { width: 44px; height: 44px; }
            
            .language-panel { flex-wrap: wrap; gap: calc(var(--spacing-unit) * 0.5); }
            .language-panel select { flex-grow: 1; min-width: 120px; }
            .language-panel #lang-detect-indicator { margin-right: calc(var(--spacing-unit) * 0.5); }
            
            .settings-popup {
                width: 280px;
                right: calc(var(--spacing-unit) * -1); /* Changed from left */
            }
         }

        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .translator-box, .language-feature > .feature-item, .history-panel, .translate-btn-container, .tone-selector-container {
            animation: fadeInScaleUp 0.6s var(--transition-slow) backwards;
        }
        .language-feature > .feature-item:nth-child(1) { animation-delay: 0.1s; }
        .language-feature > .feature-item:nth-child(2) { animation-delay: 0.2s; }
        .language-feature > .feature-item:nth-child(3) { animation-delay: 0.3s; }
        .history-panel { animation-delay: 0.4s; }
        .tone-selector-container { animation-delay: 0.05s; }
    </style>
</head>
<body>
   
    <div class="header">
        <div class="header-actions">
            <button id="settings-btn" class="header-icon-btn" title="تنظیمات">
                <i class="fas fa-cog"></i>
            </button>
            <div id="settings-popup" class="settings-popup">
                <div class="settings-section">
                    <h4><i class="fas fa-palette"></i>تنظیمات ظاهری</h4>
                     <div class="setting-item">
                        <label for="theme-switcher">حالت تاریک</label>
                        <input type="checkbox" id="theme-switcher" class="toggle-switch">
                    </div>
                </div>
                <div class="settings-section">
                    <h4><i class="fas fa-brain"></i>انتخاب موتور ترجمه</h4>
                     <div class="setting-item">
                       <label for="engine-selector">موتور فعلی</label>
                       <select id="engine-selector" style="min-width: 150px;">
                           <option value="gemini-2.5-flash" data-provider="gemini" selected>Gemini 2.5 Flash</option>
                           <option value="gemini-2.5-pro" data-provider="gemini">Gemini 2.5 Pro</option>
                           <option value="moonshotai/kimi-k2-instruct" data-provider="groq">kimi-k2 (Groq)</option>
                           <option value="other" disabled>موتور دیگر (بزودی)</option>
                       </select>
                    </div>
                </div>
                 <div class="settings-section">
                    <h4><i class="fas fa-sliders-h"></i>تنظیمات موتور ترجمه</h4>
                    <div class="setting-item">
                        <label for="temp-slider">میزان خلاقیت</label>
                        <input type="range" id="temp-slider" min="0" max="1" step="0.1" value="0.4" title="0.4">
                    </div>
                </div>
            </div>
        </div>
        <h1>Ravid Translator Pro</h1>
    </div>

    <div class="container">
        <div class="translator-box">
            <div class="text-area-container">
                <div class="language-panel">
                    <div class="language-label">زبان مبدأ</div>
                    <select id="source-language">
                        <option value="auto">تشخیص خودکار زبان</option>
                        <option value="fa">فارسی</option>
                        <option value="en">انگلیسی</option>
                        <option value="ar">عربی</option>
                        <option value="fr">فرانسوی</option>
                        <option value="de">آلمانی</option>
                        <option value="es">اسپانیایی</option>
                        <option value="ru">روسی</option>
                        <option value="zh">چینی</option>
                        <option value="ja">ژاپنی</option>
                        <option value="ko">کره‌ای</option>
                        <option value="tr">ترکی</option>
                        <option value="it">ایتالیایی</option>
                        <option value="pt">پرتغالی</option>
                        <option value="hi">هندی</option>
                    </select>
                    <span id="lang-detect-indicator" style="display: none; margin-right: 8px; font-size: 0.8em;"><i class="fas fa-spinner fa-spin"></i></span>
                    <button class="voice-btn" id="source-voice-btn" title="ورودی صوتی">
                        <i class="fas fa-microphone-alt"></i>
                    </button>
                </div>
                <textarea id="source-text" class="text-area" placeholder="متن خود را اینجا وارد کنید یا از میکروفون استفاده نمایید..."></textarea>
                <div class="controls">
                    <button class="btn clear-btn">
                        <i class="fas fa-eraser"></i>
                        <span class="btn-text">پاک کردن</span>
                    </button>
                    <span id="source-char-count" class="char-count">0 / 5000</span>
                </div>
            </div>
           
            <div class="language-selector">
                <button class="swap-btn" title="جابجایی زبان‌ها">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 3L19 6L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5 11V6H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 21L5 18L8 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 13V18H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
           
            <div class="text-area-container target-container">
                <div class="language-panel">
                    <div class="language-label">زبان مقصد</div>
                    <select id="target-language">
                        <option value="en">انگلیسی</option>
                        <option value="fa">فارسی</option>
                        <option value="ar">عربی</option>
                        <option value="fr">فرانسوی</option>
                        <option value="de">آلمانی</option>
                        <option value="es">اسپانیایی</option>
                        <option value="ru">روسی</option>
                        <option value="zh">چینی</option>
                        <option value="ja">ژاپنی</option>
                        <option value="ko">کره‌ای</option>
                        <option value="tr">ترکی</option>
                        <option value="it">ایتالیایی</option>
                        <option value="pt">پرتغالی</option>
                        <option value="hi">هندی</option>
                    </select>
                    <button class="voice-btn" id="target-voice-btn" title="خواندن ترجمه">
                        <i class="fas fa-volume-high"></i>
                    </button>
                </div>
                <textarea id="target-text" class="text-area" placeholder="ترجمه متن شما در اینجا نمایش داده خواهد شد..." readonly></textarea>
                <div class="action-buttons">
                    <button class="action-btn" id="copy-btn-target" title="کپی ترجمه">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="action-btn" id="share-btn" title="اشتراک‌گذاری">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="action-btn" id="download-btn" title="دانلود متن">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div class="controls">
                    <button class="btn copy-btn">
                        <i class="fas fa-clipboard-check"></i>
                       <span class="btn-text">کپی ترجمه</span>
                    </button>
                </div>
            </div>
        </div>
       
        <div class="loading" id="loading-indicator">
            <div class="loader"></div>
            <p>در حال پردازش و ترجمه دقیق متن شما...</p>
        </div>

        <div class="tone-selector-container">
            <div class="tone-label">انتخاب لحن ترجمه:</div>
            <div class="tone-buttons">
                <button class="btn tone-btn active" data-tone="auto">خودکار</button>
                <button class="btn tone-btn" data-tone="formal">رسمی</button>
                <button class="btn tone-btn" data-tone="informal"> خودمونی</button>
                <button class="btn tone-btn" data-tone="emotional">احساسی</button>
                <button class="btn tone-btn" data-tone="street">خیابونی</button>
            </div>
        </div>
       
        <div style="text-align: center; margin-top: calc(var(--spacing-unit) * 2);" class="translate-btn-container">
            <button class="btn translate-btn" id="main-translate-btn">
                <i class="fas fa-magic-wand-sparkles btn-icon"></i>
                <span class="btn-text">ترجمه کن</span>
                <span class="spinner"></span>
            </button>
        </div>
       
        <div class="language-feature">
            <div class="feature-item">
                <div class="feature-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="feature-title">ترجمه با هوش مصنوعی</div>
                <div class="feature-desc">بهره‌گیری از آخرین نسل مدل‌های زبانی (<span id="model-name-display">Gemini 1.5 Flash</span>) برای ترجمه‌هایی دقیق، طبیعی و با درک عمیق از مفهوم و لحن متن اصلی.</div>
            </div>
           
            <div class="feature-item">
                <div class="feature-icon">
                    <i class="fas fa-globe-asia"></i>
                </div>
                <div class="feature-title">پشتیبانی گسترده از زبان‌ها</div>
                <div class="feature-desc">ترجمه روان بین بیش از ۱۵ زبان پرکاربرد دنیا، از جمله زبان‌های پیچیده با ساختارهای گرامری متفاوت.</div>
            </div>
           
            <div class="feature-item">
                <div class="feature-icon">
                    <i class="fas fa-headset"></i>
                </div>
                <div class="feature-title">تعامل صوتی پیشرفته</div>
                <div class="feature-desc">تجربه‌ای بی‌نظیر با ورودی صوتی دقیق و خروجی گفتاری طبیعی و واضح، ترجمه را آسان‌تر از همیشه می‌کند.</div>
            </div>
        </div>
       
        <div class="history-panel">
            <div class="history-title">
                <i class="fas fa-history"></i>
                تاریخچه ترجمه‌های اخیر شما
            </div>
            <div class="history-list" id="history-list">
                </div>
        </div>
    </div>
   
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notification-text"></span>
    </div>
   
    <div class="footer">
        <p>با <i class="fas fa-heart"></i> طراحی و توسعه یافته توسط Ravid</p>
        <p>مترجم Ravid نسخه Pro | © 2025 - تمامی حقوق محفوظ است.</p>
        <div class="social-links">
            <a href="https://t.me/raviiiid" title="تلگرام Ravid" target="_blank" rel="noopener noreferrer"><i class="fab fa-telegram"></i></a>
            <a href="https://github.com/" title="پروژه در گیت‌هاب" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i></a>
            <a href="https://x.com/ravid_games" title="ارتباط با ما در توییتر" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a>
        </div>
    </div>

    <script>
        // DOM Elements Cache
        const sourceTextEl = document.getElementById('source-text');
        const targetTextEl = document.getElementById('target-text');
        const sourceLangEl = document.getElementById('source-language');
        const targetLangEl = document.getElementById('target-language');
        const sourceCharCountEl = document.getElementById('source-char-count');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const notificationEl = document.getElementById('notification');
        const notificationTextEl = document.getElementById('notification-text');
        const historyListEl = document.getElementById('history-list');
        const mainTranslateBtn = document.getElementById('main-translate-btn');
        const sourceVoiceBtn = document.getElementById('source-voice-btn');
        const targetVoiceBtn = document.getElementById('target-voice-btn');
        const toneButtonsEl = document.querySelectorAll('.tone-btn');
        const langDetectIndicatorEl = document.getElementById('lang-detect-indicator');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPopup = document.getElementById('settings-popup');
        const themeSwitcher = document.getElementById('theme-switcher');
        const tempSlider = document.getElementById('temp-slider');
        const engineSelectorEl = document.getElementById('engine-selector');
        const modelNameDisplayEl = document.getElementById('model-name-display');
        let debouncedDetectLanguage;

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            loadHistory();

            sourceTextEl.addEventListener('input', debounce(handleSourceTextInput, 300));

            document.getElementById('copy-btn-target').addEventListener('click', copyTranslation);
            document.querySelector('.controls .copy-btn').addEventListener('click', copyTranslation);

            document.getElementById('share-btn').addEventListener('click', shareTranslation);
            document.getElementById('download-btn').addEventListener('click', downloadTranslation);
            
            sourceVoiceBtn.addEventListener('click', startVoiceInput);
            targetVoiceBtn.addEventListener('click', speakTranslation);
            mainTranslateBtn.addEventListener('click', translateText);
            document.querySelector('.clear-btn').addEventListener('click', clearSourceText);
            document.querySelector('.swap-btn').addEventListener('click', swapLanguages);

            settingsBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                settingsPopup.classList.toggle('show');
            });

            document.addEventListener('click', (event) => {
                if (!settingsPopup.contains(event.target) && !settingsBtn.contains(event.target)) {
                    settingsPopup.classList.remove('show');
                }
            });

            themeSwitcher.addEventListener('change', toggleTheme);
            
            tempSlider.addEventListener('input', function() {
                this.title = this.value;
            });
            
            engineSelectorEl.addEventListener('change', () => {
                const selectedOption = engineSelectorEl.options[engineSelectorEl.selectedIndex];
                if (modelNameDisplayEl) {
                    modelNameDisplayEl.textContent = selectedOption.text;
                }
            });

            toneButtonsEl.forEach(button => {
                button.addEventListener('click', function() {
                    toneButtonsEl.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            sourceTextEl.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    translateText();
                }
            });

            debouncedDetectLanguage = debounce(async (text) => {
                if (sourceLangEl.value === 'auto' && text.length > 15) {
                    langDetectIndicatorEl.style.display = 'inline-block';
                    try {
                        const detectedLangCode = await getDetectedLanguageWithGemini(text);
                        if (detectedLangCode && Array.from(sourceLangEl.options).some(opt => opt.value === detectedLangCode)) {
                            sourceLangEl.value = detectedLangCode;
                        }
                    } catch (error) {
                        console.error("Debounced language detection error:", error);
                    } finally {
                        langDetectIndicatorEl.style.display = 'none';
                    }
                } else {
                    langDetectIndicatorEl.style.display = 'none';
                }
            }, 1000);

            sourceLangEl.addEventListener('change', () => {
                if (sourceLangEl.value !== 'auto') {
                    langDetectIndicatorEl.style.display = 'none';
                }
            });
        });


        function handleSourceTextInput() {
            const text = sourceTextEl.value;
            const charCount = text.length;
            sourceCharCountEl.textContent = `${charCount} / 5000`;

            sourceCharCountEl.classList.remove('warning', 'danger');
            if (charCount > 4800) {
                sourceCharCountEl.classList.add('danger');
            } else if (charCount > 4000) {
                sourceCharCountEl.classList.add('warning');
            }

            if (charCount > 5000) {
                sourceTextEl.value = text.substring(0, 5000);
                sourceCharCountEl.textContent = `5000 / 5000`;
                showNotification('حداکثر تعداد کاراکتر (5000) وارد شده است.', 'error');
            }

            if (sourceLangEl.value === 'auto') {
                if (text.trim().length === 0) {
                    langDetectIndicatorEl.style.display = 'none';
                } else {
                    debouncedDetectLanguage(text.trim());
                }
            } else {
                langDetectIndicatorEl.style.display = 'none';
            }
        }

        // Shared function to create the core translation prompt
        function createTranslationPrompt(sourceLangName, targetLangName, text) {
             const activeToneBtn = document.querySelector('.tone-btn.active');
            const selectedTone = activeToneBtn ? activeToneBtn.dataset.tone : 'auto';

            let toneInstruction = "";
            if (selectedTone === 'formal') toneInstruction = `The translation must be in a formal and official tone.`;
            else if (selectedTone === 'informal') toneInstruction = `The translation must be in an informal, colloquial, and friendly tone.`;
            else if (selectedTone === 'emotional') toneInstruction = `The translation must be in an emotional tone, conveying the original feelings.`;
            else if (selectedTone === 'street') toneInstruction = `The translation must be in a "street" or highly colloquial slangy tone.`;
            else toneInstruction = `Your primary goal is to preserve the original text's tone. Analyze and replicate it meticulously.`;

            return `You are an expert translator. Your task is to translate the user's text from ${sourceLangName} to ${targetLangName}.
        Key Instructions:
        1.  **Tone Application:** ${toneInstruction} This is a critical instruction.
        2.  **Idioms & Nuances:** Meticulously translate idioms, metaphors, and cultural references to their closest natural equivalent in ${targetLangName}.
        3.  **Output Format:** Return *only* the translated text. Do not include any extra notes or comments.
        4.  **Fluency:** The translation must read as if it were originally written in ${targetLangName} by a native speaker.
        5.  **Accuracy:** Ensure the core meaning and intent of the original text are perfectly conveyed.

        Translate the following text:
        "${text}"`;
        }
        
        // --- API CALL FUNCTIONS ---

        async function callGroqAPI(text, sourceLanguage, targetLanguage, model) {
            // WARNING: Storing API keys in frontend code is insecure. Use a backend proxy for production.
            const GROQ_API_KEY = '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'; // <--  کلید API گروک خود را اینجا قرار بده
            const API_URL = 'https://api.groq.com/openai/v1/chat/completions';

            if (GROQ_API_KEY === 'YOUR_GROQ_API_KEY_HERE' || !GROQ_API_KEY) {
                throw new Error('سرویس Groq به درستی پیکربندی نشده. کلید API یافت نشد.');
            }

            const sourceLangName = sourceLanguage === 'auto' ? 'the auto-detected language' : getLanguageName(sourceLanguage);
            const targetLangName = getLanguageName(targetLanguage);
            const prompt = createTranslationPrompt(sourceLangName, targetLangName, text);

            const payload = {
                messages: [{ role: 'user', content: prompt }],
                model: model,
                temperature: parseFloat(tempSlider.value) || 0.4,
                max_tokens: 2048
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Groq API Error:', errorData);
                throw new Error(errorData.error?.message || `خطای HTTP: ${response.status}`);
            }

            const data = await response.json();
            if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                return data.choices[0].message.content.trim();
            } else {
                 throw new Error('پاسخ دریافت شده از سرویس Groq قابل پردازش نیست.');
            }
        }

        async function callGeminiAPI(text, sourceLanguage, targetLanguage, model) {
            // WARNING: Storing API keys in frontend code is insecure. Use a backend proxy for production.
            const GEMINI_API_KEY = 'AIzaSyDhieT7okFYcg84H3GPQwDYdAQ1CA6eu8s'; // <-- کلید API جیمنای خود را اینجا قرار بده
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;

            if (GEMINI_API_KEY === 'YOUR_API_KEY_HERE' || !GEMINI_API_KEY) {
                throw new Error('سرویس Gemini به درستی پیکربندی نشده. کلید API یافت نشد.');
            }
            
            const sourceLangName = sourceLanguage === 'auto' ? 'the auto-detected language' : getLanguageName(sourceLanguage);
            const targetLangName = getLanguageName(targetLanguage);
            const prompt = createTranslationPrompt(sourceLangName, targetLangName, text);

            const payload = {
              contents: [{ parts: [{ "text": prompt }] }],
              generationConfig: {
                temperature: parseFloat(tempSlider.value) || 0.4,
                topP: 0.95,
                maxOutputTokens: 2048
              }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Gemini API Error:', errorData);
                throw new Error(errorData.error?.message || `خطای HTTP: ${response.status}`);
            }

            const data = await response.json();

            if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                return data.candidates[0].content.parts[0].text.trim();
            } else if (data.candidates && data.candidates[0].finishReason === 'SAFETY') {
                throw new Error('ترجمه به دلیل محدودیت‌های ایمنی Gemini متوقف شد.');
            } else {
                throw new Error('پاسخ دریافت شده از سرویس Gemini قابل پردازش نیست.');
            }
        }

        // This function will remain unchanged for language detection
        async function getDetectedLanguageWithGemini(textToDetect) {
             const GEMINI_API_KEY = 'AIzaSyDhieT7okFYcg84H3GPQwDYdAQ1CA6eu8s'; // Uses Gemini key for detection
             const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
             const prompt = `You are a language detection assistant. Detect the language of the following text and respond with ONLY the two-letter ISO 639-1 code (e.g., "en", "fa"). Text: "${textToDetect.substring(0, 100)}"`;
             const payload = { contents: [{ parts: [{ "text": prompt }] }], generationConfig: { temperature: 0.0 }};
             try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) return null;
                const data = await response.json();
                return data.candidates[0]?.content?.parts[0]?.text.trim().toLowerCase().slice(0, 2);
             } catch (error) {
                 return null;
             }
        }

        // Main translation router
        async function translateText() {
            const sourceTextValue = sourceTextEl.value.trim();
            if (!sourceTextValue) {
                showNotification('لطفاً متنی برای ترجمه وارد کنید.', 'error', 'fas fa-keyboard');
                return;
            }
            if (sourceLangEl.value !== 'auto' && sourceLangEl.value === targetLangEl.value) {
                showNotification('زبان مبدأ و مقصد یکسان است!', 'info', 'fas fa-exchange-alt');
                targetTextEl.value = sourceTextValue;
                return;
            }

            mainTranslateBtn.classList.add('loading');
            loadingIndicatorEl.style.display = 'flex';
            targetTextEl.value = '';

            const selectedOption = engineSelectorEl.options[engineSelectorEl.selectedIndex];
            const provider = selectedOption.dataset.provider;
            const model = selectedOption.value;

            try {
                let translation;
                if (provider === 'gemini') {
                    translation = await callGeminiAPI(sourceTextValue, sourceLangEl.value, targetLangEl.value, model);
                } else if (provider === 'groq') {
                    translation = await callGroqAPI(sourceTextValue, sourceLangEl.value, targetLangEl.value, model);
                } else {
                    throw new Error("موتور ترجمه انتخاب شده معتبر نیست.");
                }

                targetTextEl.value = translation;
                showNotification('ترجمه با موفقیت انجام شد.', 'success', 'fas fa-check-double');
                addToHistory(sourceTextValue, translation, sourceLangEl.value, targetLangEl.value);
            } catch (error) {
                console.error('خطا در ترجمه:', error);
                targetTextEl.value = 'خطا در ترجمه رخ داد. لطفاً دوباره امتحان کنید.';
                showNotification(`خطا در سرویس ترجمه: ${error.message}`, 'error', 'fas fa-server');
            } finally {
                mainTranslateBtn.classList.remove('loading');
                loadingIndicatorEl.style.display = 'none';
            }
        }

        function clearSourceText() {
            sourceTextEl.value = '';
            targetTextEl.value = '';
            handleSourceTextInput();
            sourceTextEl.focus();
        }

        function copyTranslation() {
            const text = targetTextEl.value.trim();
            if (!text) {
                showNotification('ترجمه‌ای برای کپی کردن وجود ندارد.', 'error');
                return;
            }
            navigator.clipboard.writeText(text)
                .then(() => showNotification('متن ترجمه کپی شد!', 'success', 'fas fa-clipboard-check'))
                .catch(() => showNotification('کپی خودکار ناموفق بود.', 'error'));
        }

        function shareTranslation() {
            const text = targetTextEl.value.trim();
            if (!text) {
                showNotification('ترجمه‌ای برای اشتراک‌گذاری نیست.', 'error');
                return;
            }
            if (navigator.share) {
                navigator.share({ title: 'ترجمه از Ravid Translator Pro', text: text })
                    .catch(error => { if (error.name !== 'AbortError') console.error(error); });
            } else {
                copyTranslation();
                showNotification('قابلیت اشتراک‌گذاری مستقیم در این مرورگر نیست. متن کپی شد.', 'info');
            }
        }

        function downloadTranslation() {
            const text = targetTextEl.value.trim();
            if (!text) {
                showNotification('ترجمه‌ای برای دانلود وجود ندارد.', 'error');
                return;
            }
            const filename = `RavidTranslate.txt`;
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
            showNotification('فایل ترجمه دانلود شد.', 'success', 'fas fa-file-download');
        }

        function swapLanguages() {
            if (sourceLangEl.value === 'auto') {
                showNotification('برای جابجایی، ابتدا زبان مبدأ را مشخص کنید.', 'info');
                return;
            }
            [sourceLangEl.value, targetLangEl.value] = [targetLangEl.value, sourceLangEl.value];
            [sourceTextEl.value, targetTextEl.value] = [targetTextEl.value, sourceTextEl.value];
            handleSourceTextInput();
            if (sourceTextEl.value.trim()) {
                translateText();
            }
        }

        function getLanguageName(langCode) {
            const el = sourceLangEl.querySelector(`option[value="${langCode}"]`);
            return el ? el.textContent : langCode;
        }

        function showNotification(message, type = 'info', iconClass = 'fas fa-info-circle') {
            const iconEl = notificationEl.querySelector('i');
            notificationEl.className = 'notification'; // Reset classes
            notificationEl.classList.add(type);
            iconEl.className = 'fas ' + (type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle');
            notificationTextEl.textContent = message;
            notificationEl.classList.add('show');
            setTimeout(() => notificationEl.classList.remove('show'), 4000);
        }

        function syncThemeControls() {
            const isDark = document.body.classList.contains('dark-mode');
            themeSwitcher.checked = isDark;
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            syncThemeControls();
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
            }
            syncThemeControls();
        }

        function addToHistory(sourceText, translatedText, sourceLang, targetLang) {
            let history = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            const historyItem = { id: Date.now(), sourceText, translatedText, sourceLang, targetLang, timestamp: new Date().toISOString() };
            history.unshift(historyItem);
            if (history.length > 30) history = history.slice(0, 30);
            localStorage.setItem('translationHistory', JSON.stringify(history));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            historyListEl.innerHTML = '';
            const history = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            if (history.length === 0) {
                historyListEl.innerHTML = `<div style="padding: 1.5rem; text-align: center; color: var(--text-color-muted);">تاریخچه خالی است.</div>`;
                return;
            }
            history.forEach(item => {
                const sourceLangName = getLanguageName(item.sourceLang);
                const targetLangName = getLanguageName(item.targetLang);
                const dateTime = new Date(item.timestamp);
                const time = dateTime.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
                const date = dateTime.toLocaleDateString('fa-IR-u-nu-latn');

                const historyItemElement = document.createElement('div');
                historyItemElement.className = 'history-item';
                historyItemElement.tabIndex = 0;
                historyItemElement.innerHTML = `
                    <div class="history-text" title="${item.sourceText.replace(/"/g, '"')}">${item.sourceText.substring(0, 70)}...</div>
                    <div class="history-langs">${sourceLangName} <i class="fas fa-long-arrow-alt-left"></i> ${targetLangName}</div>
                    <div class="date-time">${date} - ${time}</div>
                `;
                historyItemElement.addEventListener('click', () => restoreTranslation(item));
                historyListEl.appendChild(historyItemElement);
            });
        }

        function restoreTranslation(item) {
            sourceLangEl.value = item.sourceLang;
            targetLangEl.value = item.targetLang;
            sourceTextEl.value = item.sourceText;
            targetTextEl.value = item.translatedText;
            handleSourceTextInput();
            showNotification('ترجمه از تاریخچه بازیابی شد.', 'success', 'fas fa-undo-alt');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function loadHistory() { updateHistoryDisplay(); }

        let recognition;
        let isRecognizing = false;
        let currentUtterance = null;
        const synth = window.speechSynthesis;

        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showNotification('مرورگر شما از تشخیص گفتار پشتیبانی نمی‌کند.', 'error'); return;
            }
            if (isRecognizing) { recognition.stop(); return; }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            const langTagMap = { 'fa': 'fa-IR', 'en': 'en-US', 'ar': 'ar-SA', 'fr': 'fr-FR', 'de': 'de-DE', 'es': 'es-ES', 'ru': 'ru-RU', 'zh': 'zh-CN', 'ja': 'ja-JP', 'ko': 'ko-KR', 'tr': 'tr-TR', 'it': 'it-IT', 'pt': 'pt-BR', 'hi': 'hi-IN' };
            recognition.lang = sourceLangEl.value === 'auto' ? 'fa-IR' : (langTagMap[sourceLangEl.value] || 'fa-IR');
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onstart = () => {
                isRecognizing = true;
                sourceVoiceBtn.classList.add('recording');
                sourceVoiceBtn.innerHTML = '<i class="fas fa-stop-circle fa-beat"></i>';
                sourceTextEl.placeholder = "در حال شنیدن...";
            };

            recognition.onresult = event => {
                let finalTranscript = '';
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                    else interimTranscript += event.results[i][0].transcript;
                }
                sourceTextEl.value = finalTranscript + interimTranscript;
            };
            
            recognition.onend = () => {
                isRecognizing = false;
                sourceVoiceBtn.classList.remove('recording');
                sourceVoiceBtn.innerHTML = '<i class="fas fa-microphone-alt"></i>';
                sourceTextEl.placeholder = "متن خود را اینجا وارد کنید...";
                handleSourceTextInput();
                if (sourceTextEl.value.trim()) translateText();
            };

            recognition.onerror = event => { showNotification(`خطای تشخیص گفتار: ${event.error}`, 'error'); };
            recognition.start();
        }

        function speakTranslation() {
            const text = targetTextEl.value.trim();
            if (!text) { showNotification('ترجمه‌ای برای خواندن وجود ندارد.', 'error'); return; }
            if (synth.speaking) { synth.cancel(); if (currentUtterance && currentUtterance.text === text) return; }
            currentUtterance = new SpeechSynthesisUtterance(text);
            const langVoiceMap = { 'fa': 'fa-IR', 'en': 'en-US', 'ar': 'ar-SA', 'fr': 'fr-FR', 'de': 'de-DE', 'es': 'es-ES', 'ru': 'ru-RU', 'zh': 'zh-CN', 'ja': 'ja-JP', 'ko': 'ko-KR', 'tr': 'tr-TR', 'it': 'it-IT', 'pt': 'pt-BR', 'hi': 'hi-IN' };
            currentUtterance.lang = langVoiceMap[targetLangEl.value] || 'en-US';
            currentUtterance.onend = () => { targetVoiceBtn.classList.remove('recording'); targetVoiceBtn.innerHTML = '<i class="fas fa-volume-high"></i>'; };
            targetVoiceBtn.classList.add('recording'); targetVoiceBtn.innerHTML = '<i class="fas fa-stop-circle fa-beat"></i>';
            synth.speak(currentUtterance);
        }
    </script>
</body>
</html>
